<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart PhotoCopy</title>

<!-- Leaflet Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Noto+Nastaliq+Urdu:wght@400;600&display=swap" rel="stylesheet">

<style>
  /* ===== THEME ===== */
  :root{
    --bg: #f6f8fb;
    --card:#ffffff;
    --line:#e9eef5;
    --text:#0f172a;
    --muted:#64748b;
    --brand:#111827;
    --accent:#2563eb;        /* royal blue */
    --accent-2:#22c55e;      /* green ok */
    --warn:#f59e0b;
    --err:#ef4444;
    --ring: 0 0 0 4px rgba(37,99,235,.15);
    --shadow: 0 10px 30px rgba(2,6,23,.06);
    --radius: 16px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Plus Jakarta Sans', Inter, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(1000px 600px at -10% -10%, #dbeafe 0, rgba(219,234,254,0) 60%),
      radial-gradient(900px 500px at 110% -10%, #dcfce7 0, rgba(220,252,231,0) 60%),
      var(--bg);
    -webkit-font-smoothing:antialiased;
  }

  /* ===== HEADER ===== */
  header{
    position:sticky; top:0; z-index:20;
    background:linear-gradient(180deg,#ffffff 0,#ffffffcc 100%);
    backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .brand{
    display:flex;align-items:center;gap:12px;min-height:64px
  }
  .logo{
    width:44px;height:44px;border-radius:12px;
    background:conic-gradient(from 220deg, var(--accent), #60a5fa 40%, #93c5fd);
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-weight:800;letter-spacing:.5px;
    box-shadow:var(--shadow)
  }
  h1{font-size:18px;margin:0;color:var(--brand)}
  .sub{font-size:12px;color:var(--muted)}

  /* ===== LAYOUT ===== */
  main.wrap{padding-top:12px;padding-bottom:40px}
  .card{
    background:var(--card); border:1px solid var(--line);
    border-radius:var(--radius); padding:18px; margin-top:14px;
    box-shadow:var(--shadow)
  }
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
  .row-single{display:grid;grid-template-columns:1fr;gap:12px}

  /* Inputs */
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text],input[type=email],input[type=number],select,textarea{
    width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px;
    min-height:44px; outline:none; background:#fff; color:var(--text);
    transition:box-shadow .15s ease, border-color .15s ease, transform .05s ease;
  }
  input:focus, select:focus, textarea:focus{border-color:var(--accent); box-shadow:var(--ring)}
  textarea{min-height:110px; resize:vertical}
  .note-textarea{min-height:130px}

  /* Buttons */
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:#fff;
    cursor:pointer; min-height:44px; font-weight:600; transition:transform .05s ease, box-shadow .15s ease;
  }
  .btn:hover{box-shadow:0 6px 16px rgba(2,6,23,.06)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent); border-color:var(--accent); color:#fff}
  .btn.ok{background:var(--accent-2); border-color:var(--accent-2); color:#fff}
  .btn.warn{background:var(--warn); border-color:var(--warn); color:#111}
  .btn:disabled{opacity:.55; cursor:not-allowed; filter:saturate(.5)}

  /* Stepper */
  .stepper{display:flex;gap:10px;flex-wrap:wrap}
  .chip{
    padding:10px 12px;border-radius:999px;border:1px solid var(--line);
    background:#fff;color:var(--text);cursor:pointer;white-space:nowrap;
    font-weight:600; font-size:13px; transition:box-shadow .15s ease, transform .05s ease, border-color .15s ease;
  }
  .chip:hover{box-shadow:0 4px 12px rgba(2,6,23,.06)}
  .chip.active{border-color:var(--accent); box-shadow:var(--ring)}
  .chip.disabled{pointer-events:none;opacity:.55}

  .hint{color:var(--muted);font-size:12px}

  /* KPIs */
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{flex:1 1 220px;border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}

  /* Tables */
  .table-wrap{width:100%;overflow:auto;border-radius:14px;border:1px solid var(--line);background:#fff}
  .table{width:100%;border-collapse:separate;border-spacing:0 10px;min-width:960px;padding:8px}
  .table th{font-size:12px;color:var(--muted);text-align:left;white-space:nowrap;padding:0 10px}
  .table td{
    background:#f9fbff;border:1px solid var(--line);padding:10px;border-radius:12px;vertical-align:middle
  }
  .table select{min-width:150px}

  /* Desktop widen copies column & inputs (Step 3) */
  #step3 input[type="number"][id^="cp_"],
  #step3 input[type="number"][id^="mcp_"]{ width:150px; min-width:150px }
  #step3 .table th:nth-child(6), #step3 .table td:nth-child(6){ min-width:170px; white-space:nowrap }
  #step3 .table{ min-width: 1000px }

  /* Progress bar */
  .progress{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden;min-width:120px;border:1px solid var(--line)}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);width:0}

  /* Map */
  .map{height:320px;border-radius:14px;border:1px solid var(--line);overflow:hidden}

  /* Banners */
  .banner{padding:12px;border-radius:12px;background:#eef6ff;border:1px solid #c7dcff;color:#0b3b91;margin:10px 0}
  .error{background:#fff1f2;border-color:#fecdd3;color:#be123c}

  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

  /* Mobile Cards (Step 3) */
  .mobile-list{display:none}
  .m-file{border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px;margin-bottom:12px;box-shadow:var(--shadow)}
  .m-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .m-title{font-weight:700;margin-bottom:8px;word-break:break-word}
  .m-line{display:flex;gap:8px;align-items:center;font-size:13px;color:#334155;margin-top:10px;flex-wrap:wrap}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f8fafc;border:1px solid var(--line)}

  /* Tutorial language toggle */
  .tut-switch{display:flex;gap:8px;margin:10px 0}
  .tut-switch input{display:none}
  .tut-chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;cursor:pointer}
  .tut-switch input:checked + label.tut-chip{border-color:var(--accent);box-shadow:var(--ring)}

  .tut-en, .tut-ur{display:none}
  #tutorialCard:has(#langEN:checked) .tut-en{display:block}
  #tutorialCard:has(#langUR:checked) .tut-ur{display:block}

  .rtl{direction:rtl;text-align:right}
  .tut-list{margin:8px 0 0 0;padding-left:18px}
  .tut-list li{margin:2px 0}

  /* Nastaliq font for Urdu */
  @font-face{
    font-family:"Jameel Noori Nastaleeq";
    src:url("/fonts/JameelNooriNastaleeq.woff2") format("woff2");
    font-weight:400;font-style:normal;font-display:swap
  }
  .tut-ur{
    font-family:"Jameel Noori Nastaleeq","Noto Nastaliq Urdu","Nafees Nastaleeq", serif;
    font-size:18px; line-height:2; letter-spacing:0; word-spacing:.02em
  }
  .tut-ur h3{ font-weight:700 }
  .tut-ur .tut-list{ padding-right:18px; padding-left:0 }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 980px){
    .row,.row-3,.row-4{grid-template-columns:1fr}
  }
  @media (max-width: 720px){
    .wrap{padding:14px}
    h1{font-size:16px}
    .stepper{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:6px}
    .stepper::-webkit-scrollbar{height:6px}
    .stepper::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:999px}
  }
  @media (max-width: 600px){
    .card{padding:16px;border-radius:14px}
    .btn{width:100%}
    .map{height:240px}
    .kpi .box{flex:1 1 100%}
    .table-wrap{display:none}   /* hide desktop table on small screens */
    .mobile-list{display:block} /* show friendly mobile cards */
    .actions-stack{display:grid;grid-template-columns:1fr;gap:10px}
  }
</style>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <header>
    <div class="wrap brand">
      <div class="logo">SP</div>
      <div>
        <h1>Smart PhotoCopy — Online Print & Delivery</h1>
        <div class="sub">Call / WhatsApp: <strong>0318-1530761</strong></div>
      </div>
    </div>
  </header>

  <!-- ===== MAIN ===== -->
  <main class="wrap">
    <div id="msg" class="banner" style="display:none"></div>

    <!-- Stepper -->
    <div class="card">
      <div class="stepper">
        <span class="chip" id="s1">1. Your Details</span>
        <span class="chip" id="s2">2. Files</span>
        <span class="chip" id="s3">3. Printing</span>
        <span class="chip" id="s4">4. Address & Payment</span>
        <span class="chip" id="s5">5. Review & Place Order</span>
        <span class="chip" id="sTutorial" data-nolock="true"
          title="How to order"
          onclick="
            showOnly('tutorialCard');
            document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
            this.classList.add('active');
          "
        >Tutorial</span>
        <span class="chip" id="sContact" data-nolock="true" title="Get in touch">Contact</span>
      </div>
    </div>

    <!-- Step 1 -->
    <div class="card" id="step1">
      <h2 style="margin-top:0">Step 1 — Your Details</h2>
      <div class="row">
        <div>
          <label>Full Name</label>
          <input id="name" type="text" placeholder="e.g. Order Name" />
          <div class="hint">Required</div>
        </div>
        <div>
          <label>WhatsApp Number</label>
          <input id="whatsapp" type="text" placeholder="03xx-xxxxxxx or +92xxxxxxxxxx" />
          <div class="hint">Pakistan format accepted — we’ll normalize it</div>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com" />
        </div>
        <div class="actions-stack" style="display:flex;align-items:flex-end;gap:10px">
          <button class="btn primary" onclick="goStep(2)">Continue to Files →</button>
        </div>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="card" id="step2" style="display:none">
      <h2 style="margin-top:0">Step 2 — Upload PDF Files</h2>
      <div class="row">
        <div>
          <input id="pdfInput" type="file" multiple accept="application/pdf" />
          <div class="hint">Select one or more PDF files. We’ll show page counts.</div>
        </div>
        <div class="actions-stack" style="display:flex;align-items:flex-end;gap:10px">
          <button class="btn" id="btnUploadAll" onclick="uploadAll()" disabled>Upload All</button>
          <button class="btn warn" id="btnRemoveAll" onclick="removeAll()" disabled>Remove All</button>
          <button class="btn primary" onclick="goStep(3)">Next: Printing →</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table class="table" id="filesTable">
          <thead>
            <tr>
              <th>File</th>
              <th>Pages</th>
              <th>Status</th>
              <th>Progress</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="card" id="step3" style="display:none">
      <h2 style="margin-top:0">Step 3 — Printing (Separately per PDF)</h2>

      <!-- Desktop table -->
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th style="min-width:240px">File</th>
              <th>Pages</th>
              <th>Size</th>
              <th>Weight</th>
              <th>Style</th>
              <th>Copies</th>
              <th>Rate</th>
              <th>Eff. Pages</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="printBody"></tbody>
        </table>
      </div>

      <!-- Mobile cards -->
      <div id="printList" class="mobile-list" style="margin-top:10px"></div>

      <div class="card" style="margin-top:14px">
        <h3 style="margin-top:0">Printing Total</h3>
        <div class="kpi">
          <div class="box">
            <div class="hint">Total amount</div>
            <div id="k_printTotal" style="font-weight:800;font-size:20px">PKR 0</div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <label>Extra note</label>
            <textarea id="extraNoteAll" class="note-textarea" placeholder="Any special instructions?"></textarea>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">Each file’s amount includes copies. Duplex halves effective pages.</div>
      </div>

      <div class="actions-stack" style="display:flex;gap:10px;justify-content:space-between;margin-top:12px">
        <button class="btn" onclick="goStep(2)">← Back</button>
        <button class="btn primary" onclick="goStep(4)">Next: Address & Payment →</button>
      </div>
    </div>

    <!-- Step 4 -->
    <div class="card" id="step4" style="display:none">
      <h2 style="margin-top:0">Step 4 — Address & Payment</h2>
      <div class="row">
        <div>
          <label>Search location</label>
          <div class="actions-stack" style="display:flex;gap:10px">
            <input id="searchAddr" type="text" placeholder="Street / Area / City" />
            <button class="btn" onclick="searchLocation()">Search</button>
            <button class="btn" onclick="useMyLocation()">Use my location</button>
          </div>
          <div id="map" class="map" style="margin-top:10px"></div>
          <div class="row" style="margin-top:12px">
            <div>
              <label>Selected location (editable)</label>
              <input id="addrText" type="text" placeholder="Auto-filled from map search or pin" />
            </div>
            <div>
              <label>Address details (manual)</label>
              <textarea id="addrManual" class="note-textarea" placeholder="Flat, Street, Area, Landmarks, City"></textarea>
              <div class="hint">Required — order cannot be placed without manual address.</div>
            </div>
          </div>
        </div>

        <div>
          <div class="row">
            <div>
              <label>Payment Mode</label>
              <select id="payMode" onchange="onModeChange()"></select>
            </div>
            <div>
              <label>Account</label>
              <select id="payAccount"></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Transaction ID</label>
              <input id="txId" type="text" placeholder="e.g. TRX12345" />
            </div>
            <div>
              <label>How did you pay?</label>
              <input id="paidHow" type="text" placeholder="e.g. JazzCash app" />
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <h3 style="margin-top:0">Bill Summary</h3>
            <div class="kpi">
              <div class="box"><div class="hint">Printing total</div><div id="b_printTotal" style="font-weight:800;font-size:18px">PKR 0</div></div>
              <div class="box"><div class="hint">Delivery fare</div><div id="b_fare" style="font-weight:800;font-size:18px">PKR 0</div></div>
              <div class="box"><div class="hint">Grand total</div><div id="b_grand" style="font-weight:800;font-size:18px">PKR 0</div></div>
              <div class="box"><div class="hint">Pay now (30%)</div><div id="b_now" style="font-weight:800;font-size:18px">PKR 0</div></div>
              <div class="box"><div class="hint">COD (70%)</div><div id="b_cod" style="font-weight:800;font-size:18px">PKR 0</div></div>
            </div>
          </div>

          <div class="actions-stack" style="display:flex;gap:10px;justify-content:space-between;margin-top:12px">
            <button class="btn" onclick="goStep(3)">← Back</button>
            <button class="btn primary" onclick="goStep(5)">Next: Review →</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 5 -->
    <div class="card" id="step5" style="display:none">
      <h2 style="margin-top:0">Step 5 — Review & Place Order</h2>
      <div id="review"></div>
      <div class="actions-stack" style="display:flex;gap:10px;justify-content:space-between;margin-top:12px">
        <button class="btn" id="btnBackReview" onclick="goStep(4)">← Back</button>
        <button class="btn ok" onclick="placeOrder()" id="btnPlace">Place Order</button>
      </div>
    </div>

    <!-- TUTORIAL -->
    <div class="card" id="tutorialCard" style="display:none">
      <h2 style="margin-top:0">Tutorial — How to Place an Order</h2>
      <div class="tut-switch">
        <input type="radio" name="tutLang" id="langEN" checked>
        <label for="langEN" class="tut-chip">English</label>
        <input type="radio" name="tutLang" id="langUR">
        <label for="langUR" class="tut-chip">اردو</label>
      </div>

      <div class="tut-wrap">
        <!-- EN -->
        <div class="tut-en">
          <div class="banner">Smart PhotoCopy — How to Place an Order</div>
          <p class="muted">This guide explains every step to place a print order. Keep your PDFs and payment details handy.</p>
          <h3>What you need</h3>
          <ul class="tut-list">
            <li>Your PDF files (PDF only)</li>
            <li>Your name, WhatsApp number, and email</li>
            <li>A delivery address</li>
            <li>Payment details (how you paid + transaction ID)</li>
          </ul>
          <h3>Step 3 — Printing Options</h3>
          <ul class="tut-list">
            <li>Size, Weight, Style, <b>Copies</b></li>
            <li>Amount includes copies; duplex halves effective pages</li>
          </ul>
        </div>
        <!-- URDU -->
        <div class="tut-ur rtl">
          <div class="banner">اسمارٹ فوٹو کاپی — آرڈر کیسے دیں</div>
          <p class="muted">ہر مرحلہ یہاں واضح ہے۔ اپنی PDF فائلیں اور ادائیگی کی تفصیل تیار رکھیں۔</p>
        </div>
      </div>
    </div>

    <!-- CONTACT -->
    <div class="card" id="contactCard" style="display:none">
      <h2 style="margin-top:0">Contact</h2>
      <div class="row">
        <div>
          <div class="hint">Phone</div>
          <div style="font-weight:700;font-size:18px">
            <a id="cPhone" href="tel:+923181530761">+923181530761</a>
          </div>
        </div>
        <div>
          <div class="hint">Email</div>
          <div style="font-weight:700;font-size:18px">
            <a id="cEmail" href="mailto:studyappscontent@gmail.com">studyappscontent@gmail.com</a>
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top:10px">
        We're here to help. Reach out on phone or email anytime.
      </div>
    </div>
  </main>


<script>
  // ======= CONFIG =======
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzbpyCxRS1JCEuEWQGuX1b9Rnmg92tdiMyvAb0M4cYeSepASpLvmHy-f2UG5R5RrhK-DA/exec';
  const MIN_ORDER_AMOUNT = 500; // PKR (printing total)
  // ======================

  async function api(action, payload){
    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action, payload })
    });
    let data = {};
    try { data = await res.json(); } catch(e){ data = { ok:false, error:'Invalid JSON response' }; }
    return data;
  }

  const state = {
    brand: {name:'Smart PhotoCopy'},
    orderCode: null,
    priceRows: [], weights: [], sizes: [], styles: [],
    payments: { modes: [], accountsByMode:{} },
    files: [],
    totals: { printing:0, fare:0, grand:0, now:0, cod:0 },
    delivery: {
      origin:{lat:33.5987, lng:73.0519, label:'Liaquat Bagh, Murree Road Rawalpindi'},
      lat:null, lng:null, addrText:'', addrManual:'', distanceKm:0, fare:0
    },
    contact: { phone:'+923181530761', email:'studyappscontent@gmail.com' },
    currency: 'PKR',
    timezone: 'Asia/Karachi',
    currentStep: 1,
    locked: false
  };

  function showMsg(text, type='info'){
    const el = document.getElementById('msg');
    el.textContent = text;
    el.className = 'banner' + (type==='error'?' error':'');
    el.style.display = 'block';
    setTimeout(()=>{el.style.display='none'}, 6000);
  }

  function genRandomOrderCode(){
    const rnd = (len)=>Array.from(crypto.getRandomValues(new Uint32Array(len))).map(n=>String(n%10)).join('');
    return 'SPC-' + rnd(8) + '-' + rnd(5);
  }

  function lockUI(){
    state.locked = true;
    document.querySelectorAll('button, input, select, textarea').forEach(el=>{
      if (el.closest('#contactCard')) return;
      el.disabled = true; el.setAttribute('tabindex','-1');
    });
    document.querySelectorAll('.chip').forEach(el=>{
      if (el.id === 'sContact') return;
      if (el.dataset.nolock === 'true') return;
      el.classList.add('disabled');
    });
  }

  function showOnly(idToShow){
    const ids = ['step1','step2','step3','step4','step5','contactCard','tutorialCard'];
    ids.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = (id===idToShow)?'block':'none'; });
  }

  function goStep(n){
    if (state.locked && n!=='contact') return;
    const back = typeof n==='number' ? (n < state.currentStep) : false;

    if (n === 'contact'){
      showOnly('contactCard');
      for (let i=1;i<=5;i++){ document.getElementById('s'+i).classList.remove('active'); }
      document.getElementById('sContact').classList.add('active');
      return;
    }

    if (!back){
      if (n>1){
        const name = document.getElementById('name').value.trim();
        const whatsapp = normalizePak(document.getElementById('whatsapp').value.trim());
        const email = document.getElementById('email').value.trim();
        if (!name || !whatsapp || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
          showMsg('Please enter your Name, WhatsApp and a valid Email first.', 'error');
          return;
        }
      }
      if (n>2){
        if (!state.files.length){ showMsg('Please select at least one PDF file.', 'error'); return; }
      }
      if (n>3){
        for(const f of state.files){
          const opt = f.opts || {};
          if(!opt.weight||!opt.size||!opt.style){ showMsg(`Select printing options for ${f.name}.`, 'error'); return; }
        }
        // Normalize empty copies to 1 when leaving printing step
        normalizeCopiesUI();
        recalcAll();
      }
      if (n>4){
        const manual = document.getElementById('addrManual').value.trim();
        if (!manual){ showMsg('Please enter your address details (manual).', 'error'); return; }
        if (state.delivery.lat==null || state.delivery.lng==null){ showMsg('Please select your delivery location on the map.', 'error'); return; }
        const mode = document.getElementById('payMode').value;
        const acc  = document.getElementById('payAccount').value;
        if (!mode || !acc){ showMsg('Select payment mode and account.', 'error'); return; }
      }
    }

    showOnly('step'+n);
    for (let i=1;i<=5;i++){
      document.getElementById('step'+i).style.display = (i===n)?'block':'none';
      document.getElementById('s'+i).classList.toggle('active', i===n);
    }
    document.getElementById('sContact').classList.remove('active');
    document.getElementById('sTutorial')?.classList.remove('active');

    state.currentStep = n;
    if(n===3){ renderPrintingUI(); recalcAll(); }
    if(n===4){ updateBillCards(); initMapOnce(); }
    if(n===5){ renderReview(); }
  }

  function wireStepper(){
    for (let i=1;i<=5;i++){ document.getElementById('s'+i).addEventListener('click', ()=> goStep(i)); }
    document.getElementById('sContact').addEventListener('click', ()=> goStep('contact'));
  }

  async function bootstrap(){
    state.orderCode = genRandomOrderCode();
    try {
      const d = await api('bootstrap', {});
      if (!d.ok) throw new Error(d.error || 'Bootstrap failed');

      state.brand = d.brand||state.brand;
      state.currency = d.currency||state.currency;
      state.timezone=d.timezone||state.timezone;
      state.priceRows = (d.price && d.price.rows)||[];
      state.weights=(d.price && d.price.weights)||[];
      state.sizes=(d.price && d.price.sizes)||[];
      state.styles=(d.price && d.price.styles)||[];
      state.payments = d.payments||state.payments;

      if (d.contact){ state.contact = { ...state.contact, ...d.contact }; }

      const p = document.getElementById('cPhone');
      const e = document.getElementById('cEmail');
      const phone = state.contact && state.contact.phone ? state.contact.phone : '+923181530761';
      const email = state.contact && state.contact.email ? state.contact.email : 'studyappscontent@gmail.com';
      if (p){ p.textContent = phone; p.href = 'tel:'+phone; }
      if (e){ e.textContent = email; e.href = 'mailto:'+email; }

      fillPaymentModes();
    } catch (err) {
      showMsg('Bootstrap error: '+err.message, 'error');
    }
  }

  function normalizePak(n){
    n = (n||'').replace(/[^0-9+]/g,'');
    if(n.startsWith('+92')) return n;
    if(n.startsWith('92')) return '+'+n;
    if(n.startsWith('0')) return '+92'+n.slice(1);
    if(/^3\d{9}$/.test(n)) return '+92'+n;
    return n;
  }

  // === Files
  const pdfInputEl = document.getElementById('pdfInput');
  pdfInputEl.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files||[]);
    for (const file of files){ if (file.type!=='application/pdf') continue; await addFile(file); }
    e.target.value = '';
    refreshFileButtons();
  });

  function uid(){ return 'f_'+Math.random().toString(36).slice(2,9); }

  async function addFile(file){
    const id = uid();
    const pages = await countPdfPages(file).catch(()=>0);
    const rec = { id, file, name:file.name, pages, uploaded:false, driveFileId:null, driveUrl:null, progress:0, opts:{size:'',weight:'',style:'',copies:1} };
    state.files.push(rec);
    renderFileRow(rec);
  }

  function renderFileRow(rec){
    const tbody = document.getElementById('filesBody');
    const tr = document.createElement('tr'); tr.id = 'row_'+rec.id;
    tr.innerHTML = `
      <td>${escapeHtml(rec.name)}</td>
      <td><span id="pg_${rec.id}">${rec.pages||'…'}</span></td>
      <td><span id="st_${rec.id}">Selected</span></td>
      <td><div class="progress"><i id="pr_${rec.id}" style="width:0%"></i></div></td>
      <td>
        <button class="btn" id="up_${rec.id}" onclick="uploadOne('${rec.id}')">Upload</button>
        <button class="btn warn" id="rm_${rec.id}" onclick="removeOne('${rec.id}')">Remove</button>
      </td>`;
    tbody.appendChild(tr);
  }

  function refreshFileButtons(){
    const has = state.files.length>0;
    document.getElementById('btnUploadAll').disabled = !has || state.files.every(f=>f.uploaded);
    document.getElementById('btnRemoveAll').disabled = !has;
  }

  async function countPdfPages(file){
    const arr = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:new Uint8Array(arr)}).promise;
    return pdf.numPages;
  }

  async function uploadOne(id){
    if (state.locked) return;
    const f = state.files.find(x=>x.id===id); if(!f) return;
    if (f.uploaded){ showMsg(`${f.name} already uploaded.`); return; }
    if (!state.orderCode){ showMsg('Preparing order… please retry.'); return; }

    const reader = new FileReader();
    reader.onprogress = (ev)=>{ if(ev.lengthComputable){ const p = Math.round(ev.loaded/ev.total*80); setProgress(id,p);} };
    reader.onload = async ()=>{
      const base64 = reader.result; // data URL
      setStatus(id,'Uploading…');
      try{
        const res = await api('upload', {fileName:f.name, base64, mimeType: f.file? f.file.type:'application/pdf', orderCode: state.orderCode});
        if(!res.ok) throw new Error(res.error || 'Upload failed');
        f.uploaded = true; f.driveFileId = res.fileId; f.driveUrl = res.url;
        setProgress(id,100); setStatus(id,'Uploaded'); refreshFileButtons();
      }catch(err){
        setStatus(id,'Error'); showMsg('Upload failed: '+err.message,'error'); setProgress(id,0);
      }
    };
    reader.readAsDataURL(f.file);
  }

  function uploadAll(){ if(state.locked) return; for(const f of state.files){ if(!f.uploaded) uploadOne(f.id); } }
  function removeAll(){ if(state.locked) return; const ids = state.files.map(f=>f.id); ids.forEach(removeOne); pdfInputEl.value=''; }

  async function removeOne(id){
    if (state.locked) return;
    const idx = state.files.findIndex(x=>x.id===id); if(idx<0) return;
    const f = state.files[idx];
    const cleanup = ()=>{
      const tr = document.getElementById('row_'+id); if(tr) tr.remove();
      state.files.splice(idx,1); refreshFileButtons(); pdfInputEl.value='';
      if (state.currentStep===3) { renderPrintingUI(); recalcAll(); }
    };
    if (f.uploaded && f.driveFileId){
      setStatus(id,'Removing…');
      try{
        const res = await api('delete', { fileId: f.driveFileId });
        if(!res.ok) throw new Error(res.error || 'Delete failed');
        cleanup(); showMsg(`${f.name} removed.`);
      }catch(e){
        setStatus(id,'Error'); showMsg('Remove failed: '+e.message,'error');
      }
    } else { cleanup(); }
  }

  function setProgress(id,percent){ const el = document.getElementById('pr_'+id); if(el) el.style.width = percent+'%'; }
  function setStatus(id,text){ const el = document.getElementById('st_'+id); if(el) el.textContent = text; }

  // === Printing (per-file)
  const _key = s => String(s || '').trim().toLowerCase().replace(/\s|-/g, '');
  function isDuplex(style){ const t = _key(style); return t==='backtoback'||t==='duplex'||t==='twosided'||t==='2sided'||t==='double'; }
  function findPrice(weight,size,style){
    const kw=_key(weight), ks=_key(size), kt=_key(style);
    const row = (state.priceRows || []).find(r =>
      _key(r.PaperWeight)===kw && _key(r.PaperSize)===ks && _key(r.PaperStyle)===kt
    );
    return row ? Number(row.Price) : NaN;
  }

  function renderPrintingUI(){
    // Desktop table rows
    const host = document.getElementById('printBody'); host.innerHTML='';
    const sel = (id, options, value) => {
      const opts = ['<option value="">Select…</option>'].concat(options.map(v=>`<option ${v===value?'selected':''} value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
      return `<select id="${id}">${opts.join('')}</select>`;
    };
    const copiesInput = (id, value=1) => `<input type="number" id="${id}" min="1" step="1" value="${Number(value)||1}" style="max-width:110px" />`;

    // Mobile list
    const mHost = document.getElementById('printList'); mHost.innerHTML='';

    for (const f of state.files){
      if (!f.opts) f.opts = {size:'',weight:'',style:'',copies:1};

      // ---- Desktop row
      const tr = document.createElement('tr'); tr.id = 'p_'+f.id;
      tr.innerHTML = `
        <td>${escapeHtml(f.name)}</td>
        <td>${f.pages}</td>
        <td>${sel('sz_'+f.id, state.sizes, f.opts.size)}</td>
        <td>${sel('wt_'+f.id, state.weights, f.opts.weight)}</td>
        <td>${sel('st_'+f.id, state.styles, f.opts.style)}</td>
        <td>${copiesInput('cp_'+f.id, f.opts.copies || 1)}</td>
        <td id="rate_${f.id}" class="muted">—</td>
        <td id="eff_${f.id}" class="muted">—</td>
        <td id="amt_${f.id}" style="font-weight:700">—</td>
      `;
      host.appendChild(tr);

      // ---- Mobile card
      const m = document.createElement('div'); m.className='m-file'; m.id = 'mp_'+f.id;
      m.innerHTML = `
        <div class="m-title">${escapeHtml(f.name)} <span class="pill">${f.pages} pages</span></div>
        <div class="m-row">
          <div>
            <label>Size</label>
            ${sel('msz_'+f.id, state.sizes, f.opts.size)}
          </div>
          <div>
            <label>Weight</label>
            ${sel('mwt_'+f.id, state.weights, f.opts.weight)}
          </div>
        </div>
        <div class="m-row">
          <div>
            <label>Style</label>
            ${sel('mst_'+f.id, state.styles, f.opts.style)}
          </div>
          <div>
            <label>Copies</label>
            <input type="number" id="mcp_${f.id}" min="1" step="1" value="${f.opts.copies || 1}" />
          </div>
        </div>
        <div class="m-line"><span class="pill">Rate: <b id="mrate_${f.id}">—</b></span><span class="pill">Eff: <b id="meff_${f.id}">—</b></span><span class="pill">Amount: <b id="mamt_${f.id}">—</b></span></div>
      `;
      mHost.appendChild(m);

      // Desktop controls
      const szEl = tr.querySelector('#sz_'+f.id);
      const wtEl = tr.querySelector('#wt_'+f.id);
      const stEl = tr.querySelector('#st_'+f.id);
      const cpEl = tr.querySelector('#cp_'+f.id);

      // Mobile controls
      const mszEl = m.querySelector('#msz_'+f.id);
      const mwtEl = m.querySelector('#mwt_'+f.id);
      const mstEl = m.querySelector('#mst_'+f.id);
      const mcpEl = m.querySelector('#mcp_'+f.id);

      // Single source of truth: update state from whichever control changed
      const assign = (source) => {
        const readVal = (el) => (el ? el.value : '');

        // take values from the active source group
        if (source === 'm'){
          f.opts.size = readVal(mszEl);
          f.opts.weight = readVal(mwtEl);
          f.opts.style = readVal(mstEl);
          f.opts.copies = mcpEl.value; // may be empty while typing
          // mirror to desktop (if present)
          if (szEl) szEl.value = f.opts.size || '';
          if (wtEl) wtEl.value = f.opts.weight || '';
          if (stEl) stEl.value = f.opts.style || '';
          if (cpEl && mcpEl) cpEl.value = mcpEl.value;
        } else {
          f.opts.size = readVal(szEl);
          f.opts.weight = readVal(wtEl);
          f.opts.style = readVal(stEl);
          f.opts.copies = cpEl.value; // may be empty while typing
          // mirror to mobile
          if (mszEl) mszEl.value = f.opts.size || '';
          if (mwtEl) mwtEl.value = f.opts.weight || '';
          if (mstEl) mstEl.value = f.opts.style || '';
          if (mcpEl && cpEl) mcpEl.value = cpEl.value;
        }

        recalcOne(f);
        recalcAll();
      };

      // Normalize copies to >=1 only when leaving focus (lets backspace clear)
      const normalizeCopiesField = (el) => {
        const val = el.value.trim();
        if (val === '') { /* leave empty in UI */ return; }
        let n = parseInt(val, 10);
        if (!isFinite(n) || n < 1) n = 1;
        el.value = n;
      };

      // Desktop events
      [szEl, wtEl, stEl].forEach(el=>{
        el.addEventListener('change', ()=>assign('d'));
        el.addEventListener('input',  ()=>assign('d'));
      });
      if (cpEl){
        cpEl.addEventListener('input', ()=>assign('d'));
        cpEl.addEventListener('change', ()=>{ normalizeCopiesField(cpEl); assign('d'); });
        cpEl.addEventListener('blur',   ()=>{ normalizeCopiesField(cpEl); assign('d'); });
      }

      // Mobile events
      [mszEl, mwtEl, mstEl].forEach(el=>{
        el.addEventListener('change', ()=>assign('m'));
        el.addEventListener('input',  ()=>assign('m'));
      });
      if (mcpEl){
        mcpEl.addEventListener('input', ()=>assign('m'));
        mcpEl.addEventListener('change', ()=>{ normalizeCopiesField(mcpEl); assign('m'); });
        mcpEl.addEventListener('blur',   ()=>{ normalizeCopiesField(mcpEl); assign('m'); });
      }

      assign('d');
    }
  }

  // When leaving Step 3 (or placing order), coerce blank copies to 1 and sync both UIs
  function normalizeCopiesUI(){
    for (const f of state.files){
      let n = parseInt((f.opts && f.opts.copies) || '1', 10);
      if (!isFinite(n) || n < 1) n = 1;
      f.opts.copies = n;
      // sync desktop & mobile fields if present
      const d = document.getElementById('cp_'+f.id);
      const m = document.getElementById('mcp_'+f.id);
      if (d && (d.value.trim()==='' || parseInt(d.value,10) < 1)) d.value = n;
      if (m && (m.value.trim()==='' || parseInt(m.value,10) < 1)) m.value = n;
    }
  }

  function ensureAmountVisible(rowId){
    if (!window.matchMedia('(max-width: 600px)').matches) return;
    const wrap = document.querySelector('#step3 .table-wrap');
    const amt = document.getElementById('amt_'+rowId);
    if (!wrap || !amt) return;
    const a = amt.getBoundingClientRect();
    const w = wrap.getBoundingClientRect();
    if (a.right > w.right){
      wrap.scrollLeft += (a.right - w.right) + 24;
    } else if (a.left < w.left){
      wrap.scrollLeft -= (w.left - a.left) + 24;
    }
  }

  function recalcOne(f){
    const rate = findPrice(f.opts.weight, f.opts.size, f.opts.style);
    const pages = Number(f.pages)||0;
    const rawCopies = (f.opts && f.opts.copies !== undefined) ? String(f.opts.copies).trim() : '1';
    const copies = Math.max(1, parseInt(rawCopies || '1',10) || 1);

    if (!isFinite(rate) || !f.opts.weight || !f.opts.size || !f.opts.style){
      f.calc = null;
      setCell(f.id,'rate','—'); setCell(f.id,'eff','—'); setCell(f.id,'amt','—', true);
      // mobile mirrors
      mirrorMobileCells(f.id,'—','—','—');
      return;
    }
    const eff = isDuplex(f.opts.style) ? Math.ceil(pages/2) : pages;
    const sub = Math.round(eff * rate * copies);
    f.calc = { rate, effPages: eff, copies, subtotal: sub };

    setCell(f.id,'rate', formatPKR(rate));
    setCell(f.id,'eff', eff);
    setCell(f.id,'amt', formatPKR(sub), true);
    mirrorMobileCells(f.id, formatPKR(rate), eff, formatPKR(sub));
    ensureAmountVisible(f.id);
  }

  function mirrorMobileCells(id, rate, eff, amt){
    const r = document.getElementById('mrate_'+id);
    const e = document.getElementById('meff_'+id);
    const a = document.getElementById('mamt_'+id);
    if (r) r.textContent = rate;
    if (e) e.textContent = eff;
    if (a) a.textContent = amt;
  }

  function recalcAll(){
    let total = 0;
    for (const f of state.files){
      if (f.calc && isFinite(f.calc.subtotal)) total += f.calc.subtotal;
    }
    state.totals.printing = Math.round(total);
    document.getElementById('k_printTotal').textContent = formatPKR(state.totals.printing);
    updateBillCards();
  }

  function setCell(id, key, val, bold){
    const el = document.getElementById((key==='rate'?'rate_':key==='eff'?'eff_':'amt_')+id);
    if (el){ el.textContent = val; if (bold) el.style.fontWeight='700'; }
  }

  // === Map & Delivery
  let map, userMarker, originMarker;
  function initMapOnce(){
    if(map) return;
    map = L.map('map').setView([state.delivery.origin.lat, state.delivery.origin.lng], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
    originMarker = L.marker([state.delivery.origin.lat, state.delivery.origin.lng]).addTo(map).bindPopup('Origin: '+state.delivery.origin.label);
    map.on('click', e=>{ setUserLocation(e.latlng.lat, e.latlng.lng, 'Dropped on map'); });
  }

  async function searchLocation(){
    const q = document.getElementById('searchAddr').value.trim(); if(!q){ showMsg('Enter a place to search.'); return; }
    const url = 'https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q);
    try{
      const res = await fetch(url, {headers:{'Accept':'application/json'}}); const data = await res.json(); if(!data.length){ showMsg('No results found.','error'); return; }
      const {lat,lon,display_name} = data[0]; setUserLocation(parseFloat(lat), parseFloat(lon), display_name);
    }catch(e){ showMsg('Search failed. Please try again.','error'); }
  }

  function useMyLocation(){
    if(!navigator.geolocation){ showMsg('Geolocation not supported.','error'); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude,longitude} = pos.coords; setUserLocation(latitude, longitude, 'My current location');
    }, err=>{ showMsg('Could not get location.','error'); });
  }

  function setUserLocation(lat,lng,label){
    state.delivery.lat = lat; state.delivery.lng = lng; state.delivery.addrText = label || state.delivery.addrText;
    const at = document.getElementById('addrText'); if (at) at.value = state.delivery.addrText;
    if(userMarker){ userMarker.setLatLng([lat,lng]); } else { userMarker = L.marker([lat,lng]).addTo(map).bindPopup('Delivery location'); }
    map.setView([lat,lng], 13);
    computeFare();
  }

  function computeFare(){
    const o = state.delivery.origin; const d = {lat:state.delivery.lat, lng:state.delivery.lng}; if(d.lat==null||d.lng==null) return;
    const km = haversineKm(o.lat,o.lng,d.lat,d.lng);
    state.delivery.distanceKm = km;
    const fare = Math.round(km*50);
    state.delivery.fare = fare; state.totals.fare=fare;
    updateBillCards();
  }

  function haversineKm(lat1,lon1,lat2,lon2){
    const toRad = d=>d*Math.PI/180; const R=6371;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
  }

  // === Payments
  function fillPaymentModes(){
    const pm = document.getElementById('payMode');
    pm.innerHTML = '<option value="">Select…</option>' + (state.payments.modes||[]).map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');
    onModeChange();
  }
  function onModeChange(){
    const mode = document.getElementById('payMode').value; const accSel = document.getElementById('payAccount');
    const list = (state.payments.accountsByMode||{})[mode]||[];
    accSel.innerHTML = '<option value="">Select…</option>' + list.map(a=>`<option value="${escapeHtml(a.name+'|'+a.account)}">${escapeHtml(a.name)} — ${escapeHtml(a.account)}</option>`).join('');
  }

  function updateBillCards(){
    const print = state.totals.printing||0; const fare = state.totals.fare||0;
    const grand = print + fare; const now = Math.round(grand*0.30); const cod = grand - now;
    state.totals.grand=grand; state.totals.now=now; state.totals.cod=cod;
    document.getElementById('b_printTotal').textContent = formatPKR(print);
    document.getElementById('b_fare').textContent = formatPKR(fare);
    document.getElementById('b_grand').textContent = formatPKR(grand);
    document.getElementById('b_now').textContent = formatPKR(now);
    document.getElementById('b_cod').textContent = formatPKR(cod);
  }

  function formatPKR(n){ try { return new Intl.NumberFormat('en-PK',{style:'currency',currency:'PKR'}).format(n||0);}catch(e){ return 'PKR '+(n||0);} }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  // === Review & Submit
  function renderReview(){
    state.delivery.addrText = document.getElementById('addrText').value;
    state.delivery.addrManual = document.getElementById('addrManual').value;

    const filesList = state.files.map(f=>{
      const part = f.calc ? ` — ${formatPKR(f.calc.subtotal)}` : '';
      const opt = f.opts||{};
      const copies = Math.max(1, parseInt((opt.copies===''? '1' : opt.copies)||'1',10) || 1);
      return `${copies}× — ${escapeHtml(f.name)} — ${f.pages}p — ${escapeHtml(opt.size)}, ${escapeHtml(opt.weight)}, ${escapeHtml(opt.style)}${part}`;
    }).join('<br/>');

    const html = `
      <div class="card" style="margin-bottom:12px">
        <strong>Order Code:</strong> <span class="mono">${escapeHtml(state.orderCode || 'reserving…')}</span>
      </div>
      <div class="row">
        <div class="box" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
          <h3>Customer</h3>
          <div>${escapeHtml(document.getElementById('name').value)}<br/>${escapeHtml(normalizePak(document.getElementById('whatsapp').value))}<br/>${escapeHtml(document.getElementById('email').value)}</div>
          <h3 style="margin-top:12px">Files & Printing</h3>
          <div class="mono">${filesList}</div>
          <h3 style="margin-top:12px">Extra Note</h3>
          <div>${escapeHtml(document.getElementById('extraNoteAll').value)}</div>
        </div>
        <div class="box" style="border:1px solid #eee;border-radius:12px;padding:12px;background:#fff">
          <h3>Delivery</h3>
          <div>${escapeHtml(state.delivery.addrText)}<br/>${escapeHtml(state.delivery.addrManual)}</div>
          <h3 style="margin-top:12px">Payment</h3>
          <div>Mode: ${escapeHtml(document.getElementById('payMode').value)}<br/>Account: ${escapeHtml(document.getElementById('payAccount').value)}<br/>Txn: ${escapeHtml(document.getElementById('txId').value)}<br/>How: ${escapeHtml(document.getElementById('paidHow').value)}</div>
          <h3 style="margin-top:12px">Totals</h3>
          <div>Printing: ${formatPKR(state.totals.printing)}<br/>Delivery: ${formatPKR(state.totals.fare)}<br/><b>Grand: ${formatPKR(state.totals.grand)}</b><br/>Pay now: ${formatPKR(state.totals.now)} | COD: ${formatPKR(state.totals.cod)}</div>
        </div>
      </div>`;
    document.getElementById('review').innerHTML = html;
  }

  async function placeOrder(){
    if (state.locked) return;

    const name = document.getElementById('name').value.trim();
    const whatsapp = normalizePak(document.getElementById('whatsapp').value.trim());
    const email = document.getElementById('email').value.trim();
    if (!name || !whatsapp || !/^\S+@\S+\.\S+$/.test(email)) { showMsg('Please complete your details.', 'error'); return; }
    if (!state.files.length || state.files.some(f=>!f.uploaded)) { showMsg('Please upload all selected PDFs before placing the order.', 'error'); return; }

    // Make sure copies are >=1 before sending
    normalizeCopiesUI();
    recalcAll();

    // Enforce minimum printing total
    if ((state.totals.printing||0) < MIN_ORDER_AMOUNT){
      showMsg(`Sorry! Your order can't be processed because the minimum amount required is PKR ${MIN_ORDER_AMOUNT}. Please increase files or copies and try again.`, 'error');
      return;
    }

    const mode = document.getElementById('payMode').value;
    const acc = document.getElementById('payAccount').value;
    const txId = document.getElementById('txId').value.trim();
    const paidHow = document.getElementById('paidHow').value.trim();
    if (!mode || !acc || !txId || !paidHow) { showMsg('Please provide payment mode, account, transaction ID and how you paid.', 'error'); return; }

    if (state.delivery.lat==null||state.delivery.lng==null) { showMsg('Please select your delivery location on the map.', 'error'); return; }
    const manual = document.getElementById('addrManual').value.trim();
    if (!manual){ showMsg('Please enter your address details (manual).', 'error'); return; }

    const files = state.files.map(f=>({
      name: f.name,
      pages: f.pages,
      sizeBytes: f.file.size,
      driveFileId: f.driveFileId,
      driveUrl: f.driveUrl,
      options: {
        size: (f.opts&&f.opts.size)||'',
        weight: (f.opts&&f.opts.weight)||'',
        style: (f.opts&&f.opts.style)||'',
        copies: Math.max(1, parseInt((f.opts&&f.opts.copies)||'1',10) || 1) // send numeric copies
      }
    }));

    const order = {
      customer: { name, whatsapp, email },
      files,
      printMode: 'separate',
      priceRows: state.priceRows,
      delivery: {
        origin: state.delivery.origin,
        lat: state.delivery.lat, lng: state.delivery.lng,
        addressText: state.delivery.addrText,
        addressManual: manual,
        distanceKm: state.delivery.distanceKm,
        fare: state.delivery.fare
      },
      payments: { mode, account: acc, transactionId: txId, paidHow },
      totals: { printingTotal: state.totals.printing, fare: state.totals.fare, grandTotal: state.totals.grand, advanceNow: state.totals.now, codDue: state.totals.cod },
      notes: { global: document.getElementById('extraNoteAll').value },
      meta: { orderCode: state.orderCode }
    };

    const btn = document.getElementById('btnPlace'); const backBtn = document.getElementById('btnBackReview');
    btn.disabled = true; btn.textContent = 'Placing…'; backBtn.disabled = true;

    try{
      const res = await api('finalize', { order });
      btn.textContent='Place Order';
      if(res && res.ok){
        showMsg(`Your order has been processed (Code: ${res.orderCode}). Please check your email for the order copy. Our team will contact you soon. Regards.`, 'info');
        lockUI();
        window.scrollTo({top:0,behavior:'smooth'});
      } else {
        btn.disabled=false; backBtn.disabled=false;
        showMsg('Could not place order. '+(res && res.error ? res.error : ''), 'error');
      }
    }catch(err){
      btn.disabled=false; backBtn.disabled=false; btn.textContent='Place Order';
      showMsg('Error: '+err.message,'error');
    }
  }

  // Stepper + Inputs
  function initStepper(){ wireStepper(); }
  document.getElementById('addrText').addEventListener('change', ()=>{ state.delivery.addrText = document.getElementById('addrText').value; });
  document.getElementById('addrManual').addEventListener('change', ()=>{ state.delivery.addrManual = document.getElementById('addrManual').value; });

  window.addEventListener('DOMContentLoaded', ()=>{
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    initStepper();
    bootstrap();

    // Fallback toggle for browsers without :has()
    (function(){
      const en = document.getElementById('langEN');
      const ur = document.getElementById('langUR');
      const enBox = document.querySelector('#tutorialCard .tut-en');
      const urBox = document.querySelector('#tutorialCard .tut-ur');
      if (!en || !ur || !enBox || !urBox) return;
      function syncTut(){
        enBox.style.display = en.checked ? 'block' : 'none';
        urBox.style.display = ur.checked ? 'block' : 'none';
      }
      en.addEventListener('change', syncTut);
      ur.addEventListener('change', syncTut);
      syncTut();
    })();
  });
</script>
</body>
</html>

